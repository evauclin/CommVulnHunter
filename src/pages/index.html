<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Filter - D√©tection de Spam ML</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .email-item {
            border-left: 4px solid #28a745;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 10px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .email-item.spam {
            border-left-color: #dc3545;
        }

        .email-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .email-item.active {
            background-color: #e3f2fd !important;
            border-color: #2196f3;
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.3);
        }

        .card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .stats-card {
            text-align: center;
            padding: 2rem;
            color: white;
            border-radius: 15px;
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .stats-primary { background: linear-gradient(135deg, #4299e1, #3182ce); }
        .stats-success { background: linear-gradient(135deg, #48bb78, #38a169); }
        .stats-danger { background: linear-gradient(135deg, #f56565, #e53e3e); }

        .email-preview {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .analyze-section {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            border-radius: 15px;
            padding: 25px;
            color: white;
            text-align: center;
        }

        .btn-analyze {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            font-weight: 600;
            padding: 12px 30px;
            border-radius: 25px;
            transition: all 0.3s ease;
        }

        .btn-analyze:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
            color: white;
        }

        .btn-analyze:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .source-indicator {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 20px;
            border-left: 4px solid #17a2b8;
        }

        .email-type-badge {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        #emailList {
            max-height: 500px;
            overflow-y: auto;
            padding: 0 15px;
        }

        .search-controls {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .filter-buttons .btn {
            margin: 2px;
        }

        .ml-status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.85rem;
        }

        .ml-status.online {
            border-left: 4px solid #28a745;
        }

        .ml-status.offline {
            border-left: 4px solid #dc3545;
        }

        /* Scrollbar personnalis√©e */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h2 class="mb-0">
                                    <i class="bi bi-cpu text-primary"></i>
                                    Email Filter ML Dashboard
                                </h2>
                                <p class="text-muted mb-0">D√©tection de spam par Intelligence Artificielle</p>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-success" onclick="loadLiveEmails()">
                                        <i class="bi bi-cloud-download"></i> Gmail CSV
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="loadDemoEmails()">
                                        <i class="bi bi-file-text"></i> Demo
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="refreshEmails()">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                    <button type="button" class="btn btn-info" onclick="checkMLStatus()">
                                        <i class="bi bi-activity"></i> V√©rifier ML
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Source Indicator -->
        <div id="sourceIndicator" class="source-indicator" style="display: none;">
            <strong>üìä Source:</strong> <span id="sourceText">Chargement...</span>
        </div>

        <!-- Search and Filter Controls -->
        <div class="search-controls">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" id="searchInput" class="form-control"
                               placeholder="Rechercher dans les emails..."
                               onkeyup="performSearch()">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="filter-buttons text-end">
                        <button class="btn btn-outline-secondary btn-sm active" onclick="filterEmails('ALL')" data-filter="ALL">
                            <i class="bi bi-envelope"></i> Tous
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="filterEmails('IMPORTANT')" data-filter="IMPORTANT">
                            <i class="bi bi-check-circle"></i> Importants
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="filterEmails('SPAM')" data-filter="SPAM">
                            <i class="bi bi-x-circle"></i> Spam
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stats-card stats-primary">
                    <div class="display-4" id="totalEmails">0</div>
                    <h5>Emails analys√©s</h5>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card stats-success">
                    <div class="display-4" id="successRate">0%</div>
                    <h5>Taux de r√©ussite</h5>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card stats-danger">
                    <div class="display-4" id="spamCount">0</div>
                    <h5>Spams d√©tect√©s</h5>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Email List -->
            <div class="col-lg-7">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-envelope"></i>
                            Liste des emails
                        </h5>
                        <span id="emailCounter" class="badge bg-secondary">0 emails</span>
                    </div>
                    <div class="card-body p-0">
                        <div id="emailList">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Chargement...</span>
                                </div>
                                <div class="ms-3">Chargement des emails CSV...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email Preview -->
            <div class="col-lg-5">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-eye"></i>
                            Aper√ßu de l'email
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Email Details -->
                        <div class="mb-3">
                            <strong>ID:</strong>
                            <div id="emailId" class="text-muted small">S√©lectionnez un email</div>
                        </div>

                        <div class="mb-3">
                            <strong>De:</strong>
                            <div id="emailFrom" class="text-muted">S√©lectionnez un email</div>
                        </div>

                        <div class="mb-3">
                            <strong>Date:</strong>
                            <div id="emailDate" class="text-muted">-</div>
                        </div>

                        <div class="mb-3">
                            <strong>Objet:</strong>
                            <div id="emailSubject" class="text-muted">Aucun email s√©lectionn√©</div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>Contenu:</strong>
                                <div class="btn-group btn-group-sm" role="group">
                                    <input type="radio" class="btn-check" name="viewMode" id="textMode" checked>
                                    <label class="btn btn-outline-secondary" for="textMode">Texte</label>

                                    <input type="radio" class="btn-check" name="viewMode" id="htmlMode">
                                    <label class="btn btn-outline-secondary" for="htmlMode">HTML</label>
                                </div>
                            </div>
                            <div id="emailBody" class="email-preview">
                                S√©lectionnez un email dans la liste pour voir son contenu ici.
                            </div>
                        </div>

                        <!-- Analysis Section -->
                        <div class="analyze-section">
                            <h6 class="mb-3">
                                <i class="bi bi-cpu"></i>
                                Analyse par Intelligence Artificielle
                            </h6>

                            <!-- ML Status -->
                            <div id="mlStatus" class="ml-status">
                                <i class="bi bi-circle-fill text-warning"></i>
                                Statut ML: V√©rification en cours...
                            </div>

                            <button id="analyzeBtn" class="btn btn-analyze mb-3" onclick="analyzeEmail()" disabled>
                                <i class="bi bi-brain"></i>
                                ANALYSER AVEC IA
                            </button>

                            <div id="analysisResult" class="mb-3"></div>

                            <!-- Satisfaction -->
                            <div class="mt-3 p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                                <div class="mb-2">√ätes-vous satisfait de l'analyse ?</div>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="satisfaction" id="satisfactionYes" value="yes">
                                        <label class="form-check-label" for="satisfactionYes">
                                            <i class="bi bi-hand-thumbs-up"></i> Oui
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="satisfaction" id="satisfactionNo" value="no">
                                        <label class="form-check-label" for="satisfactionNo">
                                            <i class="bi bi-hand-thumbs-down"></i> Non
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>



    <script>
        // üìß EMAIL LOADER INT√âGR√â
        const emailLoader = {
            emails: [],

            // Emails de d√©monstration
            generateDemoEmails() {
                return [
                    {
                        id: "demo_001",
                        from: "service@amazon.com",
                        subject: "Confirmation de commande #FR-2025-001",
                        body: "Bonjour,\n\nVotre commande a √©t√© confirm√©e et sera exp√©di√©e sous 24h.\n\nCordialement,\nL'√©quipe Amazon",
                        date: new Date('2025-06-01T10:30:00'),
                        type: "IMPORTANT"
                    },
                    {
                        id: "demo_002",
                        from: "no-reply@paypal-security.net",
                        subject: "üîí URGENT: Votre compte sera suspendu dans 24h",
                        body: "ATTENTION! Votre compte PayPal pr√©sente une activit√© suspecte.\n\nCliquez ICI pour v√©rifier: http://paypal-verification-secure.net/login\n\nSi vous n'agissez pas, votre compte sera d√©finitivement ferm√©.\n\nPayPal Security Team",
                        date: new Date('2025-06-02T14:15:00'),
                        type: "SPAM"
                    },
                    {
                        id: "demo_003",
                        from: "newsletter@lepoint.fr",
                        subject: "Les actualit√©s du jour - 5 juin 2025",
                        body: "Bonjour,\n\nRetrouvez les principales actualit√©s de ce jeudi :\n\n‚Ä¢ √âconomie : Les march√©s en hausse\n‚Ä¢ Politique : Nouvelles r√©formes annonc√©es\n‚Ä¢ International : Sommet europ√©en\n\nBonne lecture !\nLa r√©daction du Point",
                        date: new Date('2025-06-05T08:00:00'),
                        type: "IMPORTANT"
                    },
                    {
                        id: "demo_004",
                        from: "winner@mega-lottery.biz",
                        subject: "üéâ F√âLICITATIONS! Vous avez gagn√© 500.000‚Ç¨!",
                        body: "INCROYABLE! Vous avez √©t√© s√©lectionn√© comme GRAND GAGNANT de notre loterie internationale!\n\nVotre num√©ro gagnant: FR-2025-WINNER-001\nGain: 500.000 EUROS\n\nPour r√©cup√©rer votre prix, envoyez-nous :\n- Copie de votre pi√®ce d'identit√©\n- Coordonn√©es bancaires\n- Frais de traitement: 299‚Ç¨\n\nF√©licitations!\nMega Lottery International",
                        date: new Date('2025-06-03T16:45:00'),
                        type: "SPAM"
                    },
                    {
                        id: "demo_005",
                        from: "contact@pole-emploi.fr",
                        subject: "Nouvelles offres d'emploi correspondant √† votre profil",
                        body: "Bonjour,\n\nNous avons trouv√© 3 nouvelles offres d'emploi qui correspondent √† vos crit√®res de recherche :\n\n1. D√©veloppeur Full Stack - Paris\n2. Chef de projet IT - Lyon  \n3. Data Scientist - Toulouse\n\nConsultez votre espace personnel pour plus de d√©tails.\n\nCordialement,\nP√¥le emploi",
                        date: new Date('2025-06-04T11:20:00'),
                        type: "IMPORTANT"
                    },
                    {
                        id: "demo_006",
                        from: "admin@banque-credit-agricole.secure.net",
                        subject: "Mise √† jour de s√©curit√© requise - Action imm√©diate",
                        body: "Cher client,\n\nSuite √† une tentative de connexion suspecte sur votre compte, nous avons temporairement suspendu votre acc√®s.\n\nPour r√©activer votre compte, connectez-vous via ce lien s√©curis√© :\nhttp://credit-agricole-secure-login.net/update\n\nVous devrez :\n- Confirmer vos identifiants\n- V√©rifier vos coordonn√©es\n- Mettre √† jour votre mot de passe\n\nCr√©dit Agricole - Service S√©curit√©",
                        date: new Date('2025-06-05T09:15:00'),
                        type: "SPAM"
                    }
                ];
            },

            // Charger les emails de d√©monstration
            loadDemoEmails() {
                console.log('üìß Chargement des emails de d√©monstration...');
                this.emails = this.generateDemoEmails();
                this.updateDisplay();
                this.updateStats();

                // Mettre √† jour l'indicateur de source
                const sourceIndicator = document.getElementById('sourceIndicator');
                const sourceText = document.getElementById('sourceText');
                if (sourceIndicator && sourceText) {
                    sourceText.textContent = 'Emails de d√©monstration (6 emails)';
                    sourceIndicator.style.display = 'block';
                }

                console.log(`‚úÖ ${this.emails.length} emails de d√©monstration charg√©s`);
            },

            // Charger emails depuis CSV (simulation)
            loadLiveEmails() {
                console.log('üìß Simulation de chargement CSV...');

                // Pour la d√©mo, on charge les emails de d√©monstration
                // Dans un vrai cas, ici vous chargeriez le fichier CSV
                this.loadDemoEmails();

                const sourceIndicator = document.getElementById('sourceIndicator');
                const sourceText = document.getElementById('sourceText');
                if (sourceIndicator && sourceText) {
                    sourceText.textContent = 'Simulation CSV Gmail (6 emails)';
                    sourceIndicator.style.display = 'block';
                }
            },

            // Nettoyer le contenu des emails
            cleanEmailContent(content) {
                if (!content) return '';

                return content
                    .replace(/\r\n/g, '\n')
                    .replace(/\r/g, '\n')
                    .replace(/\n{3,}/g, '\n\n')
                    .trim();
            },

            // Formater la date
            formatDate(date) {
                if (!date) return 'Date inconnue';

                if (typeof date === 'string') {
                    date = new Date(date);
                }

                return date.toLocaleString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },

            // Afficher les emails
            displayEmails(container, emailsToShow = null) {
                if (!container) {
                    console.error('‚ùå Conteneur email introuvable');
                    return;
                }

                const emails = emailsToShow || this.emails;

                if (emails.length === 0) {
                    container.innerHTML = `
                        <div class="text-center p-4">
                            <i class="bi bi-envelope-x text-muted" style="font-size: 3rem;"></i>
                            <h5 class="text-muted mt-3">Aucun email trouv√©</h5>
                            <p class="text-muted">Chargez des emails ou modifiez vos filtres</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = emails.map((email, index) => {
                    const typeClass = email.type === 'SPAM' ? 'spam' : '';
                    const typeIcon = email.type === 'SPAM' ? '‚ö†Ô∏è' : '‚úÖ';
                    const typeBadge = email.type === 'SPAM' ?
                        '<span class="email-type-badge bg-danger text-white">SPAM</span>' :
                        '<span class="email-type-badge bg-success text-white">IMPORTANT</span>';

                    return `
                        <div class="email-item ${typeClass}" data-index="${index}" onclick="selectEmail(${index})">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    <strong class="d-block">${email.from}</strong>
                                    <small class="text-muted">${this.formatDate(email.date)}</small>
                                </div>
                                <div class="text-end">
                                    ${typeBadge}
                                </div>
                            </div>
                            <div class="mb-2">
                                <strong>${email.subject}</strong>
                            </div>
                            <div class="text-muted small">
                                ${email.body.substring(0, 100)}${email.body.length > 100 ? '...' : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                console.log(`üìß ${emails.length} emails affich√©s`);
            },

            // Mettre √† jour l'affichage
            updateDisplay() {
                const container = document.getElementById('emailList');
                this.displayEmails(container);

                // Mettre √† jour le compteur
                const counter = document.getElementById('emailCounter');
                if (counter) {
                    counter.textContent = `${this.emails.length} emails`;
                }
            },

            // Mettre √† jour les statistiques
            updateStats() {
                const total = this.emails.length;
                const spamCount = this.emails.filter(email => email.type === 'SPAM').length;
                const importantCount = total - spamCount;
                const successRate = total > 0 ? Math.round((importantCount / total) * 100) : 0;

                // Mettre √† jour les √©l√©ments
                const totalElement = document.getElementById('totalEmails');
                const successElement = document.getElementById('successRate');
                const spamElement = document.getElementById('spamCount');

                if (totalElement) totalElement.textContent = total;
                if (successElement) successElement.textContent = `${successRate}%`;
                if (spamElement) spamElement.textContent = spamCount;

                console.log(`üìä Stats: ${total} total, ${spamCount} spam, ${successRate}% l√©gitime`);
            }
        };

        // üîß FONCTIONS GLOBALES POUR LES BOUTONS
        function loadDemoEmails() {
            emailLoader.loadDemoEmails();
            applyFiltersAndSearch();
        }

        function loadLiveEmails() {
            emailLoader.loadLiveEmails();
            applyFiltersAndSearch();
        }

        function refreshEmails() {
            console.log('üîÑ Rafra√Æchissement des emails...');
            // Recharger les m√™mes emails
            emailLoader.updateDisplay();
            emailLoader.updateStats();
            applyFiltersAndSearch();
        }

        // Variables globales
        let currentFilter = 'ALL';
        let currentSearchQuery = '';
        let filteredEmails = [];
        let mlApiUrl = 'http://localhost:800';
        let mlStatusOnline = false;

        // V√©rification du statut du mod√®le ML
        async function checkMLStatus() {
            const statusElement = document.getElementById('mlStatus');
            const analyzeBtn = document.getElementById('analyzeBtn');

            statusElement.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> V√©rification du mod√®le ML...';

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(`${mlApiUrl}/health`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (response.ok) {
                    const data = await response.json();
                    mlStatusOnline = true;
                    statusElement.innerHTML = `
                        <i class="bi bi-circle-fill text-success"></i>
                        Mod√®le ML: <strong>En ligne</strong> - ${data.status || 'Pr√™t'}
                    `;
                    statusElement.className = 'ml-status online';
                    analyzeBtn.disabled = false;
                    console.log('‚úÖ Mod√®le ML disponible', data);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                mlStatusOnline = false;
                let errorMsg = error.message;

                if (error.name === 'AbortError') {
                    errorMsg = 'Timeout - V√©rifiez que l\'API est d√©marr√©e';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg = 'CORS Error - Ajoutez les headers CORS √† votre API';
                }

                statusElement.innerHTML = `
                    <i class="bi bi-circle-fill text-danger"></i>
                    Mod√®le ML: <strong>Hors ligne</strong><br>
                    <small>${errorMsg}</small>
                `;
                statusElement.className = 'ml-status offline';
                analyzeBtn.disabled = true;
                console.error('‚ùå Mod√®le ML indisponible:', error);

                // Instructions pour r√©soudre le probl√®me CORS
                if (error.message.includes('Failed to fetch')) {
                    console.log('üîß Pour r√©soudre le probl√®me CORS, ajoutez ceci √† votre API FastAPI:');
                    console.log(`
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
                    `);
                }
            }
        }

        // Fonction de nettoyage de texte
        function cleanText(text) {
            if (!text || typeof text !== 'string') {
                return '';
            }

            // Supprimer les espaces multiples
            const noExtraSpaces = text.split(/\s+/).join(' ').trim();

            // Remplacer les guillemets droits par des guillemets typographiques
            const safeQuotes = noExtraSpaces
                .replace(/"/g, '"')  // Guillemets doubles
                .replace(/'/g, ' '); // Guillemets simples

            return safeQuotes;
        }

        // Analyse d'email avec le mod√®le ML uniquement
        async function analyzeEmail() {
            if (!mlStatusOnline) {
                showAnalysisError('Le mod√®le ML n\'est pas disponible. Veuillez v√©rifier la connexion.');
                return;
            }

            const resultDiv = document.getElementById('analysisResult');
            const analyzeBtn = document.getElementById('analyzeBtn');

            // R√©cup√©rer le contenu de l'email
            const emailFrom = document.getElementById('emailFrom').textContent;
            const emailSubject = document.getElementById('emailSubject').textContent;
            const emailBody = document.getElementById('emailBody').textContent;

            if (emailFrom === 'S√©lectionnez un email' || !emailSubject || !emailBody) {
                showAnalysisError('Veuillez s√©lectionner un email complet √† analyser.');
                return;
            }

            // Combiner et nettoyer le contenu
            const rawEmailText = `From: ${emailFrom} Subject: ${emailSubject} Body: ${emailBody}`;
            const cleanedEmailText = cleanText(rawEmailText);

            console.log('üìß Analyse ML d√©marr√©e');
            console.log('Longueur du texte:', cleanedEmailText.length);

            // Animation de chargement
            analyzeBtn.disabled = true;
            resultDiv.innerHTML = `
                <div class="text-info">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    <strong>Analyse IA en cours...</strong>
                    <br><small>Traitement par r√©seau de neurones LSTM</small>
                </div>
            `;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const response = await fetch(`${mlApiUrl}/predict`, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: cleanedEmailText
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('ü§ñ R√©ponse ML:', data);

                // Afficher le r√©sultat
                displayMLResult(data);

            } catch (error) {
                console.error('‚ùå Erreur lors de l\'analyse ML:', error);

                let errorMsg = error.message;
                if (error.name === 'AbortError') {
                    errorMsg = 'Timeout - L\'analyse a pris trop de temps';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg = 'Probl√®me de connexion CORS - V√©rifiez votre API';
                }

                showAnalysisError(`Erreur ML: ${errorMsg}`);

                // V√©rifier √† nouveau le statut ML
                setTimeout(checkMLStatus, 1000);
            } finally {
                analyzeBtn.disabled = false;
            }
        }

        // Affichage des r√©sultats ML
        function displayMLResult(data) {
            const resultDiv = document.getElementById('analysisResult');
            const confidence = Math.round((data.probability || 0) * 100);

            let result, className, icon;

            if (data.prediction === 'phishing') {
                result = `SPAM/PHISHING d√©tect√©`;
                className = 'text-danger';
                icon = '‚ö†Ô∏è';
            } else {
                result = `Email L√âGITIME`;
                className = 'text-success';
                icon = '‚úÖ';
            }

            resultDiv.innerHTML = `
                <div class="${className}">
                    <strong>${icon} ${result}</strong>
                    <br>Confiance: <strong>${confidence}%</strong>
                    <br><small class="text-muted">
                        Mod√®le: LSTM Deep Learning
                        ${data.confidence ? `- Niveau: ${data.confidence}` : ''}
                    </small>
                </div>
            `;

            // Log pour debug
            console.log(`üéØ R√©sultat: ${data.prediction} (${confidence}%)`);
        }

        // Affichage des erreurs
        function showAnalysisError(message) {
            const resultDiv = document.getElementById('analysisResult');
            resultDiv.innerHTML = `
                <div class="error-message">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Erreur d'analyse</strong>
                    <br>${message}
                    <br><small class="text-muted">V√©rifiez que l'API ML est d√©marr√©e sur le port 800</small>
                </div>
            `;
        }

        // Fonctions de recherche et filtrage (inchang√©es)
        function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            currentSearchQuery = query;
            applyFiltersAndSearch();
        }

        function filterEmails(type) {
            currentFilter = type;

            document.querySelectorAll('.filter-buttons .btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === type) {
                    btn.classList.add('active');
                }
            });

            applyFiltersAndSearch();
        }

        function applyFiltersAndSearch() {
            let emails = emailLoader.emails;

            if (currentFilter !== 'ALL') {
                emails = emails.filter(email => email.type === currentFilter);
            }

            if (currentSearchQuery) {
                const query = currentSearchQuery.toLowerCase();
                emails = emails.filter(email =>
                    (email.from && email.from.toLowerCase().includes(query)) ||
                    (email.subject && email.subject.toLowerCase().includes(query)) ||
                    (email.body && email.body.toLowerCase().includes(query))
                );
            }

            filteredEmails = emails;

            const container = document.getElementById('emailList');
            emailLoader.displayEmails(container, filteredEmails);

            const counter = document.getElementById('emailCounter');
            if (counter) {
                const total = emailLoader.emails.length;
                const filtered = filteredEmails.length;
                counter.textContent = filtered === total ?
                    `${total} emails` :
                    `${filtered}/${total} emails`;
            }
        }

        // S√©lection d'email
        function selectEmail(index) {
            const email = filteredEmails[index] || emailLoader.emails[index];
            if (!email) return;

            document.querySelectorAll('.email-item').forEach(item => {
                item.classList.remove('active');
            });

            const emailElement = document.querySelector(`[data-index="${index}"]`);
            if (emailElement) {
                emailElement.classList.add('active');
            }

            const elements = {
                id: document.getElementById('emailId'),
                from: document.getElementById('emailFrom'),
                date: document.getElementById('emailDate'),
                subject: document.getElementById('emailSubject'),
                body: document.getElementById('emailBody'),
                analyzeBtn: document.getElementById('analyzeBtn')
            };

            if (elements.id) elements.id.textContent = email.id || 'N/A';
            if (elements.from) elements.from.textContent = email.from;
            if (elements.date) elements.date.textContent = emailLoader.formatDate(email.date);
            if (elements.subject) elements.subject.textContent = email.subject;

            if (elements.body) {
                elements.body.dataset.textContent = email.body;
                elements.body.dataset.htmlContent = email.body;
                updateBodyDisplay();
            }

            if (elements.analyzeBtn) {
                elements.analyzeBtn.dataset.emailType = email.type;
            }

            // Reset analysis
            const analysisResult = document.getElementById('analysisResult');
            if (analysisResult) analysisResult.innerHTML = '';

            document.querySelectorAll('input[name="satisfaction"]').forEach(input => {
                input.checked = false;
            });
        }

        // Mise √† jour de l'affichage du contenu
        function updateBodyDisplay() {
            const bodyElement = document.getElementById('emailBody');
            const isHtmlMode = document.getElementById('htmlMode').checked;
            const rawContent = bodyElement.dataset.textContent || '';

            if (isHtmlMode && rawContent.includes('<')) {
                let htmlContent = rawContent
                    .replace(/<script[^>]*>.*?<\/script>/gis, '')
                    .replace(/<style[^>]*>.*?<\/style>/gis, '');

                bodyElement.innerHTML = htmlContent;
                bodyElement.style.fontFamily = 'inherit';
                bodyElement.style.whiteSpace = 'normal';
            } else {
                const cleanContent = emailLoader.cleanEmailContent(rawContent);
                bodyElement.textContent = cleanContent || rawContent;
                bodyElement.style.fontFamily = "'Courier New', monospace";
                bodyElement.style.whiteSpace = 'pre-wrap';
            }
        }

        // Gestion du feedback
        function handleFeedback(satisfaction) {
            const emailType = document.getElementById('analyzeBtn').dataset.emailType;
            const resultDiv = document.getElementById('analysisResult');

            if (satisfaction === 'yes') {
                resultDiv.innerHTML += '<br><span class="text-success">üëç Merci pour votre feedback positif !</span>';
            } else {
                resultDiv.innerHTML += '<br><span class="text-warning">üëé Merci, nous am√©liorerons notre mod√®le ML.</span>';
            }

            console.log(`Feedback ML: ${satisfaction} pour email type: ${emailType}`);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initialisation du dashboard ML...');

            // Chargement automatique des emails de d√©monstration
            loadDemoEmails();

            // V√©rifier le statut ML
            checkMLStatus();

            // Feedback satisfaction
            document.querySelectorAll('input[name="satisfaction"]').forEach(input => {
                input.addEventListener('change', function() {
                    if (this.checked) {
                        handleFeedback(this.value);
                    }
                });
            });

            // Mode d'affichage du contenu
            document.querySelectorAll('input[name="viewMode"]').forEach(input => {
                input.addEventListener('change', updateBodyDisplay);
            });
        });

        // CSS pour l'animation de rotation
        const style = document.createElement('style');
        style.textContent = `
            .spin {
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>