<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Filter - D√©tection de Spam CSV</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .email-item {
            border-left: 4px solid #28a745;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 10px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .email-item.spam {
            border-left-color: #dc3545;
        }

        .email-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .email-item.active {
            background-color: #e3f2fd !important;
            border-color: #2196f3;
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.3);
        }

        .card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .stats-card {
            text-align: center;
            padding: 2rem;
            color: white;
            border-radius: 15px;
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .stats-primary { background: linear-gradient(135deg, #4299e1, #3182ce); }
        .stats-success { background: linear-gradient(135deg, #48bb78, #38a169); }
        .stats-danger { background: linear-gradient(135deg, #f56565, #e53e3e); }

        .email-preview {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .analyze-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            padding: 25px;
            color: white;
            text-align: center;
        }

        .btn-analyze {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            font-weight: 600;
            padding: 12px 30px;
            border-radius: 25px;
            transition: all 0.3s ease;
        }

        .btn-analyze:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
            color: white;
        }

        .source-indicator {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 20px;
            border-left: 4px solid #17a2b8;
        }

        .email-type-badge {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        #emailList {
            max-height: 500px;
            overflow-y: auto;
            padding: 0 15px;
        }

        .search-controls {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .filter-buttons .btn {
            margin: 2px;
        }

        /* Scrollbar personnalis√©e */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h2 class="mb-0">
                                    <i class="bi bi-shield-check text-primary"></i>
                                    Email Filter Dashboard CSV
                                </h2>
                                <p class="text-muted mb-0">D√©tection intelligente de spam avec format CSV</p>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-success" onclick="loadLiveEmails()">
                                        <i class="bi bi-cloud-download"></i> Gmail CSV
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="loadDemoEmails()">
                                        <i class="bi bi-file-text"></i> Demo
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="refreshEmails()">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Source Indicator -->
        <div id="sourceIndicator" class="source-indicator" style="display: none;">
            <strong>üìä Source:</strong> <span id="sourceText">Chargement...</span>
        </div>

        <!-- Search and Filter Controls -->
        <div class="search-controls">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" id="searchInput" class="form-control"
                               placeholder="Rechercher dans les emails..."
                               onkeyup="performSearch()">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="filter-buttons text-end">
                        <button class="btn btn-outline-secondary btn-sm active" onclick="filterEmails('ALL')" data-filter="ALL">
                            <i class="bi bi-envelope"></i> Tous
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="filterEmails('IMPORTANT')" data-filter="IMPORTANT">
                            <i class="bi bi-check-circle"></i> Importants
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="filterEmails('SPAM')" data-filter="SPAM">
                            <i class="bi bi-x-circle"></i> Spam
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stats-card stats-primary">
                    <div class="display-4" id="totalEmails">0</div>
                    <h5>Emails analys√©s</h5>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card stats-success">
                    <div class="display-4" id="successRate">0%</div>
                    <h5>Taux de r√©ussite</h5>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card stats-danger">
                    <div class="display-4" id="spamCount">0</div>
                    <h5>Spams d√©tect√©s</h5>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Email List -->
            <div class="col-lg-7">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-envelope"></i>
                            Liste des emails
                        </h5>
                        <span id="emailCounter" class="badge bg-secondary">0 emails</span>
                    </div>
                    <div class="card-body p-0">
                        <div id="emailList">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Chargement...</span>
                                </div>
                                <div class="ms-3">Chargement des emails CSV...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email Preview -->
            <div class="col-lg-5">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-eye"></i>
                            Aper√ßu de l'email
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Email Details -->
                        <div class="mb-3">
                            <strong>ID:</strong>
                            <div id="emailId" class="text-muted small">S√©lectionnez un email</div>
                        </div>

                        <div class="mb-3">
                            <strong>De:</strong>
                            <div id="emailFrom" class="text-muted">S√©lectionnez un email</div>
                        </div>

                        <div class="mb-3">
                            <strong>Date:</strong>
                            <div id="emailDate" class="text-muted">-</div>
                        </div>

                        <div class="mb-3">
                            <strong>Objet:</strong>
                            <div id="emailSubject" class="text-muted">Aucun email s√©lectionn√©</div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>Contenu:</strong>
                                <div class="btn-group btn-group-sm" role="group">
                                    <input type="radio" class="btn-check" name="viewMode" id="textMode" checked>
                                    <label class="btn btn-outline-secondary" for="textMode">Texte</label>

                                    <input type="radio" class="btn-check" name="viewMode" id="htmlMode">
                                    <label class="btn btn-outline-secondary" for="htmlMode">HTML</label>
                                </div>
                            </div>
                            <div id="emailBody" class="email-preview">
                                S√©lectionnez un email dans la liste pour voir son contenu ici.
                            </div>
                        </div>

                        <!-- Analysis Section -->
                        <div class="analyze-section">
                            <h6 class="mb-3">
                                <i class="bi bi-cpu"></i>
                                Analyse Simple (Mode Al√©atoire)
                            </h6>

                            <button id="analyzeBtn" class="btn btn-analyze mb-3" onclick="analyzeEmail()">
                                <i class="bi bi-shuffle"></i>
                                ANALYSER (RANDOM)
                            </button>

                            <div id="analysisResult" class="mb-3"></div>

                            <!-- Satisfaction -->
                            <div class="mt-3 p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                                <div class="mb-2">√ätes-vous satisfait de l'analyse ?</div>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="satisfaction" id="satisfactionYes" value="yes">
                                        <label class="form-check-label" for="satisfactionYes">
                                            <i class="bi bi-hand-thumbs-up"></i> Oui
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="satisfaction" id="satisfactionNo" value="no">
                                        <label class="form-check-label" for="satisfactionNo">
                                            <i class="bi bi-hand-thumbs-down"></i> Non
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- CSV Email Loader -->
    <script src="csvEmailLoader.js"></script>

    <script>
        // Variables globales pour la recherche et le filtrage
        let currentFilter = 'ALL';
        let currentSearchQuery = '';
        let filteredEmails = [];

        // Fonctions de recherche et filtrage
        function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            currentSearchQuery = query;
            applyFiltersAndSearch();
        }

        function filterEmails(type) {
            currentFilter = type;

            // Mettre √† jour l'apparence des boutons
            document.querySelectorAll('.filter-buttons .btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === type) {
                    btn.classList.add('active');
                }
            });

            applyFiltersAndSearch();
        }

        function applyFiltersAndSearch() {
            let emails = emailLoader.emails;

            // Appliquer le filtre de type
            if (currentFilter !== 'ALL') {
                emails = emails.filter(email => email.type === currentFilter);
            }

            // Appliquer la recherche
            if (currentSearchQuery) {
                const query = currentSearchQuery.toLowerCase();
                emails = emails.filter(email =>
                    (email.from && email.from.toLowerCase().includes(query)) ||
                    (email.subject && email.subject.toLowerCase().includes(query)) ||
                    (email.body && email.body.toLowerCase().includes(query))
                );
            }

            filteredEmails = emails;

            // Afficher les r√©sultats
            const container = document.getElementById('emailList');
            emailLoader.displayEmails(container, filteredEmails);

            // Mettre √† jour le compteur
            const counter = document.getElementById('emailCounter');
            if (counter) {
                const total = emailLoader.emails.length;
                const filtered = filteredEmails.length;
                counter.textContent = filtered === total ?
                    `${total} emails` :
                    `${filtered}/${total} emails`;
            }
        }

        // Fonction de s√©lection d'email mise √† jour
        function selectEmail(index) {
            // Utiliser l'index dans la liste filtr√©e
            const email = filteredEmails[index] || emailLoader.emails[index];
            if (!email) return;

            // Supprimer la s√©lection pr√©c√©dente
            document.querySelectorAll('.email-item').forEach(item => {
                item.classList.remove('active');
            });

            // Ajouter la nouvelle s√©lection
            const emailElement = document.querySelector(`[data-index="${index}"]`);
            if (emailElement) {
                emailElement.classList.add('active');
            }

            // Afficher l'aper√ßu
            const elements = {
                id: document.getElementById('emailId'),
                from: document.getElementById('emailFrom'),
                date: document.getElementById('emailDate'),
                subject: document.getElementById('emailSubject'),
                body: document.getElementById('emailBody'),
                analyzeBtn: document.getElementById('analyzeBtn')
            };

            if (elements.id) elements.id.textContent = email.id || 'N/A';
            if (elements.from) elements.from.textContent = email.from;
            if (elements.date) elements.date.textContent = emailLoader.formatDate(email.date);
            if (elements.subject) elements.subject.textContent = email.subject;

            if (elements.body) {
                elements.body.dataset.textContent = email.body;
                elements.body.dataset.htmlContent = email.body;
                updateBodyDisplay();
            }

            if (elements.analyzeBtn) {
                elements.analyzeBtn.dataset.emailType = email.type;
            }

            // Reset analysis
            const analysisResult = document.getElementById('analysisResult');
            if (analysisResult) analysisResult.textContent = '';

            document.querySelectorAll('input[name="satisfaction"]').forEach(input => {
                input.checked = false;
            });
        }

        // Met √† jour l'affichage du contenu selon le mode
        function updateBodyDisplay() {
            const bodyElement = document.getElementById('emailBody');
            const isHtmlMode = document.getElementById('htmlMode').checked;
            const rawContent = bodyElement.dataset.textContent || '';

            if (isHtmlMode && rawContent.includes('<')) {
                // Mode HTML : afficher le rendu (mais s√©curis√©)
                let htmlContent = rawContent
                    .replace(/<script[^>]*>.*?<\/script>/gis, '') // Supprimer scripts
                    .replace(/<style[^>]*>.*?<\/style>/gis, '');  // Supprimer styles

                bodyElement.innerHTML = htmlContent;
                bodyElement.style.fontFamily = 'inherit';
                bodyElement.style.whiteSpace = 'normal';
            } else {
                // Mode texte : afficher le contenu nettoy√©
                const cleanContent = emailLoader.cleanEmailContent(rawContent);
                bodyElement.textContent = cleanContent || rawContent;
                bodyElement.style.fontFamily = "'Courier New', monospace";
                bodyElement.style.whiteSpace = 'pre-wrap';
            }
        }

        // Analyse un email
        function analyzeEmail() {
            const emailType = document.getElementById('analyzeBtn').dataset.emailType;
            const resultDiv = document.getElementById('analysisResult');

            // Animation de chargement
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Analyse en cours...';

            setTimeout(() => {
                // Simulation d'analyse al√©atoire
                const confidence = Math.floor(Math.random() * 30) + 70; // 70-99%
                let result = '';
                let className = '';

                if (emailType === 'IMPORTANT') {
                    result = `‚úÖ Email class√© IMPORTANT (Confiance: ${confidence}%)`;
                    className = 'text-success';
                } else if (emailType === 'SPAM') {
                    result = `‚ö†Ô∏è Email class√© SPAM (Confiance: ${confidence}%)`;
                    className = 'text-warning';
                } else {
                    result = '‚ùì Classification al√©atoire en cours...';
                    className = 'text-muted';
                }

                resultDiv.innerHTML = `
                    <div class="${className}">
                        ${result}
                        <br><small class="text-muted">Mode: Classification al√©atoire</small>
                    </div>
                `;
            }, 1000);
        }

        // Gestion du feedback
        function handleFeedback(satisfaction) {
            const emailType = document.getElementById('analyzeBtn').dataset.emailType;
            const resultDiv = document.getElementById('analysisResult');

            if (satisfaction === 'yes') {
                resultDiv.innerHTML = '<span class="text-success">üëç Merci pour votre feedback positif !</span>';
            } else {
                resultDiv.innerHTML = '<span class="text-warning">üëé Merci, nous am√©liorerons notre d√©tection.</span>';
            }

            console.log(`Feedback CSV: ${satisfaction} pour email type: ${emailType}`);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Feedback satisfaction
            document.querySelectorAll('input[name="satisfaction"]').forEach(input => {
                input.addEventListener('change', function() {
                    if (this.checked) {
                        handleFeedback(this.value);
                    }
                });
            });

            // Mode d'affichage du contenu
            document.querySelectorAll('input[name="viewMode"]').forEach(input => {
                input.addEventListener('change', updateBodyDisplay);
            });

            // Chargement initial
            console.log('üöÄ Initialisation du dashboard CSV...');
            loadLiveEmails();
        });
    </script>
</body>
</html>