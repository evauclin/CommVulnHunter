<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Filter - D√©tection de Spam</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .email-item {
            border-left: 4px solid #28a745;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .email-item.spam {
            border-left-color: #dc3545;
        }

        .email-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .email-item.active {
            background-color: #e3f2fd !important;
            border-color: #2196f3;
        }

        .card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .stats-card {
            text-align: center;
            padding: 2rem;
            color: white;
            border-radius: 15px;
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .stats-primary { background: linear-gradient(135deg, #4299e1, #3182ce); }
        .stats-success { background: linear-gradient(135deg, #48bb78, #38a169); }
        .stats-danger { background: linear-gradient(135deg, #f56565, #e53e3e); }

        .email-preview {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .analyze-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            padding: 25px;
            color: white;
            text-align: center;
        }

        .btn-analyze {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            font-weight: 600;
            padding: 12px 30px;
            border-radius: 25px;
            transition: all 0.3s ease;
        }

        .btn-analyze:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .email-controls {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .source-indicator {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 20px;
            border-left: 4px solid #17a2b8;
        }

        .email-type-badge {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        #emailList {
            max-height: 500px;
            overflow-y: auto;
        }

        /* Scrollbar personnalis√©e */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h2 class="mb-0">
                                    <i class="bi bi-shield-check text-primary"></i>
                                    Email Filter Dashboard
                                </h2>
                                <p class="text-muted mb-0">D√©tection intelligente de spam en temps r√©el</p>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-success" onclick="loadLiveEmails()">
                                        <i class="bi bi-cloud-download"></i> Gmail
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="loadDemoEmails()">
                                        <i class="bi bi-file-text"></i> Demo
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="refreshEmails()">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Source Indicator -->
        <div id="sourceIndicator" class="source-indicator" style="display: none;">
            <strong>üìä Source:</strong> <span id="sourceText">Chargement...</span>
        </div>

        <!-- Statistics -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stats-card stats-primary">
                    <div class="display-4" id="totalEmails">0</div>
                    <h5>Emails analys√©s</h5>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card stats-success">
                    <div class="display-4" id="successRate">0%</div>
                    <h5>Taux de r√©ussite</h5>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card stats-danger">
                    <div class="display-4" id="spamCount">0</div>
                    <h5>Spams d√©tect√©s</h5>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Email List -->
            <div class="col-lg-7">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-envelope"></i>
                            Liste des emails
                        </h5>
                        <span id="emailCounter" class="badge bg-secondary">0 emails</span>
                    </div>
                    <div class="card-body p-0">
                        <div id="emailList">
                            <div class="text-center p-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <div class="mt-2">Chargement des emails...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email Preview -->
            <div class="col-lg-5">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-eye"></i>
                            Aper√ßu de l'email
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Email Details -->
                        <div class="mb-3">
                            <strong>De:</strong>
                            <div id="emailFrom" class="text-muted">S√©lectionnez un email</div>
                        </div>

                        <div class="mb-3">
                            <strong>Objet:</strong>
                            <div id="emailSubject" class="text-muted">Aucun email s√©lectionn√©</div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>Contenu:</strong>
                                <div class="btn-group btn-group-sm" role="group">
                                    <input type="radio" class="btn-check" name="viewMode" id="textMode" checked>
                                    <label class="btn btn-outline-secondary" for="textMode">Texte</label>

                                    <input type="radio" class="btn-check" name="viewMode" id="htmlMode">
                                    <label class="btn btn-outline-secondary" for="htmlMode">HTML</label>
                                </div>
                            </div>
                            <div id="emailBody" class="email-preview">
                                S√©lectionnez un email dans la liste pour voir son contenu ici.
                            </div>
                        </div>

                        <!-- Analysis Section -->
                        <div class="analyze-section">
                            <h6 class="mb-3">
                                <i class="bi bi-cpu"></i>
                                Analyse automatique
                            </h6>

                            <button id="analyzeBtn" class="btn btn-analyze mb-3">
                                <i class="bi bi-search"></i>
                                ANALYSER
                            </button>

                            <div id="analysisResult" class="mb-3"></div>

                            <!-- Satisfaction -->
                            <div class="mt-3 p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                                <div class="mb-2">√ätes-vous satisfait de l'analyse ?</div>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="satisfaction" id="satisfactionYes" value="yes">
                                        <label class="form-check-label" for="satisfactionYes">
                                            <i class="bi bi-hand-thumbs-up"></i> Oui
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="satisfaction" id="satisfactionNo" value="no">
                                        <label class="form-check-label" for="satisfactionNo">
                                            <i class="bi bi-hand-thumbs-down"></i> Non
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Data -->
    <script id="emailData" type="text/plain">
[IMPORTANT]
From: alice@example.com
To: moi@monemail.com
Date: 2025-05-25 09:15
Subject: R√©union urgente demain

Bonjour,

Nous avons une r√©union urgente demain √† 10h00 pour finaliser le projet.
Merci de pr√©parer les documents n√©cessaires.

Cordialement,
Alice

--------------------------------------------

[IMPORTANT]
From: Google Payments <payments-noreply@google.com>
To: moi@monemail.com
Date: 2025-05-28 15:49
Subject: Colab : Merci

Google

Merci
Vous avez effectu√© un paiement associ√© √† Colab.
Si vous avez achet√© un abonnement, vous pouvez l'annuler.

--------------------------------------------

[SPAM]
From: "Suivre-votre-colis" <spam@fake.com>
To: moi@monemail.com
Date: 2025-05-12 05:44
Subject: Vous avez un colis en attente

Colis suspendu - Cliquez ici pour confirmer votre adresse.
URGENT: Votre colis sera retourn√©!

--------------------------------------------

[IMPORTANT]
From: bob@example.com
To: moi@monemail.com
Date: 2025-05-24 14:30
Subject: Projet finalis√©, √† valider

Salut,

Le projet est maintenant finalis√©.
Peux-tu v√©rifier les derniers points ?

Merci,
Bob

--------------------------------------------

[SPAM]
From: promo123@spamdomain.com
To: moi@monemail.com
Date: 2025-05-26 08:00
Subject: Offre incroyable √† ne pas rater !!!

Gagnez 1000‚Ç¨ chaque jour en cliquant ici !
Offre limit√©e, d√©p√™chez-vous !

--------------------------------------------

[IMPORTANT]
From: Microsoft Azure <azure@microsoft.com>
To: moi@monemail.com
Date: 2025-05-29 06:07
Subject: Formation Azure gratuite

D√©couvrez comment rationaliser la migration des charges de travail.
Inscrivez-vous √† notre formation gratuite.

--------------------------------------------
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Variables globales
        let currentEmails = [];
        let currentSource = 'demo';

        // Parse les emails avec classification automatique si manquante
        function parseEmails(text) {
            const emailBlocks = text.trim().split('--------------------------------------------');
            return emailBlocks.map(block => {
                const lines = block.trim().split('\n');
                if (lines.length < 5) return null;

                let type = '', from = '', to = '', date = '', subject = '', body = '';
                let i = 0;

                // Type (s'il existe)
                if (lines[0].startsWith('[')) {
                    type = lines[0].replace(/\[|\]/g, '');
                    i++;
                }

                // Parse headers
                for (; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.startsWith('From:')) from = line.substring(5).trim();
                    else if (line.startsWith('To:')) to = line.substring(3).trim();
                    else if (line.startsWith('Date:')) date = line.substring(5).trim();
                    else if (line.startsWith('Subject:')) {
                        subject = line.substring(8).trim();
                        i++;
                        break;
                    }
                }

                // Body
                body = lines.slice(i).join('\n').trim();

                // Classification automatique si pas de type d√©fini
                if (!type) {
                    type = classifyEmail(from, subject, body);
                }

                return { type, from, to, date, subject, body };
            }).filter(email => email !== null);
        }

        // Classifie automatiquement un email comme SPAM ou IMPORTANT
        function classifyEmail(from, subject, body) {
            const spamIndicators = [
                // Exp√©diteurs suspects
                /no-?reply.*@.*\.(us|tk|ml|ga|cf)$/i,
                /^[A-Z0-9]{8,}@/i,
                /\.(us|tk|ml|ga|cf)$/i,

                // Sujets suspects
                /URGENT|F√âLICITATIONS|GAGNEZ|CADEAU|GRATUIT|PROMO|SOLDE|R√âDUCTION|OFFRE|CLIQUEZ/i,
                /‚Ç¨|EUROS|ARGENT|CASINO|LOTERIE|VIAGRA|MEDICAMENT/i,
                /COMPL√âTEZ|R√âCUP√âREZ|D√âBLOQUEZ|MAINTENANT/i,

                // Contenu suspect
                /cliquez.*ici|votre.*colis|en.*attente|suspendu|expir√©/i,
                /confirmer.*adresse|mettre.*√†.*jour|v√©rifier.*compte/i,
                /f√©licitations.*gagn√©|prix.*gratuit|remise.*exclusive/i
            ];

            const textToCheck = `${from} ${subject} ${body}`.toLowerCase();

            // V√©rifier les indicateurs de spam
            for (let indicator of spamIndicators) {
                if (indicator.test(textToCheck)) {
                    return 'SPAM';
                }
            }

            // Services connus comme importants
            const legitimateServices = [
                /@(google|microsoft|amazon|apple|github|linkedin|facebook|twitter)\.com/i,
                /@(gmail|outlook|hotmail|yahoo)\.com/i,
                /@.*\.(edu|gov|org)$/i,
                /noreply@.*\.(fr|com|net)$/i
            ];

            for (let service of legitimateServices) {
                if (service.test(from)) {
                    return 'IMPORTANT';
                }
            }

            // Par d√©faut, consid√©rer comme important si pas d'indicateur de spam
            return 'IMPORTANT';
        }

        // Nettoie le contenu d'un email
        function cleanEmailContent(content) {
            if (!content) return '';

            // Si c'est du HTML, extraire le texte visible
            if (content.includes('<') && content.includes('>')) {
                // Supprimer les balises HTML mais garder le contenu
                let cleaned = content
                    .replace(/<script[^>]*>.*?<\/script>/gis, '') // Supprimer scripts
                    .replace(/<style[^>]*>.*?<\/style>/gis, '')   // Supprimer styles
                    .replace(/<[^>]+>/g, ' ')                     // Supprimer balises HTML
                    .replace(/&nbsp;/g, ' ')                      // Remplacer &nbsp;
                    .replace(/&amp;/g, '&')                       // D√©coder &amp;
                    .replace(/&lt;/g, '<')                        // D√©coder &lt;
                    .replace(/&gt;/g, '>')                        // D√©coder &gt;
                    .replace(/&quot;/g, '"')                      // D√©coder &quot;
                    .replace(/\s+/g, ' ')                         // Multiples espaces en un
                    .trim();

                return cleaned;
            }

            // Sinon, juste nettoyer les espaces
            return content.replace(/\s+/g, ' ').trim();
        }

        // Affiche les emails
        function displayEmails(emails) {
            currentEmails = emails;
            const container = document.getElementById('emailList');

            if (emails.length === 0) {
                container.innerHTML = '<div class="text-center p-4 text-muted">Aucun email trouv√©</div>';
                updateStats(emails);
                return;
            }

            // Cr√©er la structure HTML directement (pas de sous-listes)
            let html = '';
            emails.forEach((email, index) => {
                const isSpam = email.type === 'SPAM';
                const cleanBody = cleanEmailContent(email.body);

                html += `
                    <div class="email-item ${isSpam ? 'spam' : ''}" onclick="selectEmail(${index})" data-index="${index}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <strong class="me-2">${truncate(email.from, 35)}</strong>
                                    <span class="email-type-badge ${isSpam ? 'bg-danger' : 'bg-success'} text-white">
                                        ${email.type}
                                    </span>
                                </div>
                                <div class="text-dark fw-semibold mb-1">${truncate(email.subject, 50)}</div>
                                <div class="text-muted small">${truncate(cleanBody, 70)}</div>
                            </div>
                            <div class="text-end ms-3">
                                <small class="text-muted">${formatDate(email.date)}</small>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            updateStats(emails);

            // S√©lectionner le premier email
            if (emails.length > 0) {
                selectEmail(0);
            }
        }

        // S√©lectionne un email
        function selectEmail(index) {
            // Supprimer la s√©lection pr√©c√©dente
            document.querySelectorAll('.email-item').forEach(item => {
                item.classList.remove('active');
            });

            // Ajouter la s√©lection
            const emailElement = document.querySelector(`[data-index="${index}"]`);
            if (emailElement) {
                emailElement.classList.add('active');
            }

            // Afficher l'aper√ßu
            const email = currentEmails[index];
            if (email) {
                document.getElementById('emailFrom').textContent = email.from;
                document.getElementById('emailSubject').textContent = email.subject;

                // Stocker le contenu pour les deux modes d'affichage
                const bodyElement = document.getElementById('emailBody');
                bodyElement.dataset.textContent = email.body;
                bodyElement.dataset.htmlContent = email.body;

                // Afficher selon le mode s√©lectionn√©
                updateBodyDisplay();

                // Stocker le type pour l'analyse
                document.getElementById('analyzeBtn').dataset.emailType = email.type;

                // Reset analysis
                document.getElementById('analysisResult').textContent = '';
                document.querySelectorAll('input[name="satisfaction"]').forEach(input => {
                    input.checked = false;
                });
            }
        }

        // Met √† jour l'affichage du contenu selon le mode
        function updateBodyDisplay() {
            const bodyElement = document.getElementById('emailBody');
            const isHtmlMode = document.getElementById('htmlMode').checked;
            const rawContent = bodyElement.dataset.textContent || '';

            if (isHtmlMode && rawContent.includes('<')) {
                // Mode HTML : afficher le rendu (mais s√©curis√©)
                let htmlContent = rawContent
                    .replace(/<script[^>]*>.*?<\/script>/gis, '') // Supprimer scripts
                    .replace(/<style[^>]*>.*?<\/style>/gis, '');  // Supprimer styles

                bodyElement.innerHTML = htmlContent;
                bodyElement.style.fontFamily = 'inherit';
                bodyElement.style.whiteSpace = 'normal';
            } else {
                // Mode texte : afficher le contenu nettoy√©
                const cleanContent = cleanEmailContent(rawContent);
                bodyElement.textContent = cleanContent || rawContent;
                bodyElement.style.fontFamily = "'Courier New', monospace";
                bodyElement.style.whiteSpace = 'pre-wrap';
            }
        }

        // Met √† jour les statistiques
        function updateStats(emails) {
            const total = emails.length;
            const spamEmails = emails.filter(e => e.type === 'SPAM').length;
            const importantEmails = emails.filter(e => e.type === 'IMPORTANT').length;
            const successRate = total > 0 ? Math.round((importantEmails / total) * 100) : 0;

            document.getElementById('totalEmails').textContent = total;
            document.getElementById('successRate').textContent = successRate + '%';
            document.getElementById('spamCount').textContent = spamEmails;
            document.getElementById('emailCounter').textContent = `${total} emails`;
        }

        // Charge les emails de d√©mo
        function loadDemoEmails() {
            showSource('üîÑ Chargement des emails de d√©monstration...', 'text-warning');

            // Essayer de charger depuis archive_mails.txt
            fetch('archive_mails.txt')
                .then(response => {
                    if (!response.ok) throw new Error('Fichier non trouv√©');
                    return response.text();
                })
                .then(text => {
                    const emails = parseEmails(text);
                    displayEmails(emails);
                    currentSource = 'demo';
                    showSource('üìÅ Emails de d√©monstration charg√©s', 'text-info');
                })
                .catch(() => {
                    // Fallback vers les donn√©es int√©gr√©es
                    const emailText = document.getElementById('emailData').textContent;
                    const emails = parseEmails(emailText);
                    displayEmails(emails);
                    currentSource = 'embedded';
                    showSource('üì¶ Emails int√©gr√©s (fallback)', 'text-warning');
                });
        }

        // Charge les emails Gmail
        function loadLiveEmails() {
            showSource('üîÑ Chargement des emails Gmail...', 'text-warning');

            fetch('archive_mails_live.txt')
                .then(response => {
                    if (!response.ok) throw new Error('Fichier live non trouv√©');
                    return response.text();
                })
                .then(text => {
                    const emails = parseEmails(text);
                    displayEmails(emails);
                    currentSource = 'live';
                    showSource('‚úÖ Emails Gmail charg√©s avec succ√®s', 'text-success');
                })
                .catch(() => {
                    showSource('‚ùå Emails Gmail indisponibles - Retour aux emails de d√©mo', 'text-warning');
                    loadDemoEmails();
                });
        }

        // Actualise les emails
        function refreshEmails() {
            if (currentSource === 'live') {
                loadLiveEmails();
            } else {
                loadDemoEmails();
            }
        }

        // Affiche l'indicateur de source
        function showSource(message, className = 'text-info') {
            const indicator = document.getElementById('sourceIndicator');
            const text = document.getElementById('sourceText');

            text.textContent = message;
            text.className = className;
            indicator.style.display = 'block';

            // Masquer automatiquement les messages de succ√®s
            if (className === 'text-success') {
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 3000);
            }
        }

        // Analyse un email
        function analyzeEmail() {
            const emailType = document.getElementById('analyzeBtn').dataset.emailType;
            const resultDiv = document.getElementById('analysisResult');

            // Animation de chargement
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Analyse en cours...';

            setTimeout(() => {
                let result = '';
                if (emailType === 'IMPORTANT') {
                    result = '‚úÖ Ce mail est class√© comme IMPORTANT';
                } else if (emailType === 'SPAM') {
                    result = '‚ö†Ô∏è Ce mail est class√© comme SPAM';
                } else {
                    result = '‚ùì Classification non d√©termin√©e';
                }
                resultDiv.textContent = result;
            }, 1000);
        }

        // Gestion du feedback
        function handleFeedback(satisfaction) {
            const emailType = document.getElementById('analyzeBtn').dataset.emailType;
            const resultDiv = document.getElementById('analysisResult');

            if (satisfaction === 'yes') {
                resultDiv.innerHTML = 'üëç Merci pour votre feedback positif !';
            } else {
                resultDiv.innerHTML = 'üëé Merci, nous am√©liorerons notre d√©tection.';
            }

            console.log(`Feedback: ${satisfaction} pour email type: ${emailType}`);
        }

        // Utilitaires
        function truncate(text, length) {
            return text && text.length > length ? text.substring(0, length) + '...' : text || '';
        }

        function formatDate(dateStr) {
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit'
                });
            } catch {
                return dateStr || '';
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Bouton analyser
            document.getElementById('analyzeBtn').addEventListener('click', analyzeEmail);

            // Feedback satisfaction
            document.querySelectorAll('input[name="satisfaction"]').forEach(input => {
                input.addEventListener('change', function() {
                    if (this.checked) {
                        handleFeedback(this.value);
                    }
                });
            });

            // Mode d'affichage du contenu
            document.querySelectorAll('input[name="viewMode"]').forEach(input => {
                input.addEventListener('change', updateBodyDisplay);
            });

            // Chargement initial
            loadDemoEmails();

            // Essayer de charger Gmail apr√®s 2 secondes
            setTimeout(() => {
                console.log('Tentative de chargement automatique Gmail...');
                loadLiveEmails();
            }, 2000);
        });
    </script>
</body>
</html>